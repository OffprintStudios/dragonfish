<script lang="ts">
    import { navigating } from '$app/stores';
    import {
        CloseLine,
        SearchEyeLine,
        MenuLine,
    } from 'svelte-remixicon';
    import { open, close, sidenav } from '$lib/components/nav/sidenav/sidenav.state';
    import UserMenu from '$lib/components/ui/user/UserMenu.svelte';
    import { session } from '$lib/repo/session.repo';
    import InboxMenu from '$lib/components/ui/user/InboxMenu.svelte';
    import ContentMenu from '../ui/user/ContentMenu.svelte';
    import { useQuery } from '@sveltestack/svelte-query';
    import { fetchAllUnread } from '$lib/services/activity.service';
    import MobileMenu from '$lib/components/nav/MobileMenu.svelte';
    import { fly, fade } from 'svelte/transition';
    import MobileBanner from './MobileBanner.svelte';

    enum MenuOptions {
        NoMenu,
        UserMenu,
        CreateMenu,
        MobileMenu,
        InboxMenu,
    }

    let currentMenu = MenuOptions.NoMenu;
    $: {
        if (!$sidenav.isOpen) {
            currentMenu = MenuOptions.NoMenu;
        }
    }

    function toggleMenu(menuOption: MenuOptions) {
        currentMenu = menuOption;
        switch (currentMenu) {
            case MenuOptions.UserMenu:
                open(UserMenu);
                break;
            case MenuOptions.CreateMenu:
                open(ContentMenu);
                break;
            case MenuOptions.InboxMenu:
                open(InboxMenu);
                break;
            case MenuOptions.MobileMenu:
                open(MobileMenu);
                break;
            default:
                close();
                break;
        }
    }

    navigating.subscribe((val) => {
        if (val !== null) {
            currentMenu = MenuOptions.NoMenu;
            close();
        }
    });

    const activity = useQuery('unreadActivity', () => fetchAllUnread($session.currProfile._id), {
        enabled: !!$session.currProfile,
        cacheTime: 1000 * 60 * 0.25,
    });
</script>
<div class="md:hidden">
    {#if currentMenu === MenuOptions.MobileMenu}
        <div
            class="link-mobile select-none cursor-pointer group"
            class:active={currentMenu === MenuOptions.MobileMenu}
            on:click={() => toggleMenu(MenuOptions.NoMenu)}
        >
            <span class="link-icon"><CloseLine size="24px" /></span>
        </div>
    {:else}
        <div
            class="link-mobile select-none cursor-pointer group"
            class:active={currentMenu === MenuOptions.MobileMenu}
            on:click={() => toggleMenu(MenuOptions.MobileMenu)}
        >
            <span class="link-icon"><MenuLine size="24px" /></span>
        </div>
    {/if}
    <a href="/search" class="right-0 link-mobile select-none cursor-pointer group">
        <span class="link-icon"><SearchEyeLine size="24px" /></span>
    </a>
</div>
<div class="relative">
    {#if $sidenav.isOpen}
        <div class="fixed z-40 top-0 h-screen w-full flex">
            <div
                class="fixed z-30 bg-neutral-900 w-full h-screen opacity-75 backdrop-blur-md"
                transition:fade|local={{ delay: 0, duration: 100 }}
                on:click={close}
            />
            <div class="menu" transition:fly|local={{ delay: 0, duration: 200, x: -200 }}>
                <svelte:component this={$sidenav.component} />
            </div>
        </div>
    {/if}

    <MobileBanner />
    <slot />
</div>

<style lang="scss">
    a.link-mobile,
    div.link-mobile {
        @apply fixed block m-2 z-50 rounded-lg text-white transition transform flex flex-col items-center justify-center w-[50px] h-[50px];
        background: var(--accent-transparent);
    }
    div.menu {
        @apply h-screen z-40 relative min-w-[24rem] max-w-[24rem];
        background: var(--background);
    }
</style>
