<ng-container *ngIf="createMode; else viewMode">
    <ng-container *ngIf="!editMode; else showForm">
        <div class="expandable-bar" (click)="toggleEditMode()">
            <div class="avatar-block" *ngIf="pseudQuery.currentId">
                <img [src]="pseudQuery.current.profile.avatar" [alt]="'avatar'">
            </div>
            <div class="title">
                <h3>Add a Comment</h3>
            </div>
        </div>
    </ng-container>

    <ng-template #showForm>
        <form [formGroup]="commentForm" class="mx-auto">
            <div class="expandable-bar no-bottom">
                <div class="avatar-block" *ngIf="pseudQuery.currentId">
                    <img [src]="pseudQuery.current.profile.avatar" [alt]="'avatar'">
                </div>
                <div class="title flex-1">
                    <h3>Add a Comment</h3>
                </div>
                <div>
                    <button (click)="openMultiQuote()">
                        <rmx-icon name="double-quotes-l"></rmx-icon>
                        <span>Multiquote</span>
                    </button>
                </div>
            </div>
            <dragonfish-editor-lite [formControlName]="'body'" [attachedToTop]="true"></dragonfish-editor-lite>
            <div class="flex items-center justify-end p-1">
                <button type="button" class="shadow-none border-none px-2.5 py-1.5" (click)="toggleEditMode()">
                    <rmx-icon name="close-line"></rmx-icon>
                    Cancel
                </button>
                <div class="mx-1"><!--spacer--></div>
                <button type="button" class="primary shadow-none border-none px-2.5 py-1.5" (click)="submitForm()">
                    <rmx-icon name="check-line"></rmx-icon>
                    Submit
                </button>
            </div>
        </form>
    </ng-template>
</ng-container>

<ng-template #viewMode>
    <ng-container *ngIf="editMode; else viewingComment">
        <div class="comment-box border-gray-600 dark:border-white">
            <div class="comment-top border-gray-600 dark:border-white">
                <img class="block border-2 border-gray-600 dark:border-white rounded-md w-10 h-10" [src]="comment.user.profile.avatar" [alt]="'avatar'">
                <div class="mx-1"></div>
                <div class="ml-0.5">
                    <div class="flex items-center relative top-1">
                        <dragonfish-role-badge [roles]="comment.user.roles" [size]="'small'"></dragonfish-role-badge>
                        <h5 class="font-medium ml-0.5 relative top-0.5">
                            <a [routerLink]="['/profile', comment.user._id, comment.user.userTag]">
                                {{ comment.user.screenName }}
                            </a>
                        </h5>
                    </div>
                    <div class="flex items-center">
                        <span class="text-xs italic relative top-0.5">{{ comment.user.profile.tagline ? comment.user.profile.tagline : 'Member' }}</span>
                        <span class="mx-1">•</span>
                        <span class="text-xs italic relative top-0.5">{{ comment.createdAt | localedate: 'mediumDate' }}</span>
                    </div>
                </div>
                <div class="flex-1"></div>
                <button>
                    <rmx-icon name="save-3-line"></rmx-icon>
                    <span>Save</span>
                </button>
                <button (click)="toggleEditMode()">
                    <rmx-icon name="close-line"></rmx-icon>
                    <span>Cancel</span>
                </button>
            </div>
            <form [formGroup]="commentForm">
                <dragonfish-editor-lite [formControlName]="'body'" [attachedToTop]="true" [showBorders]="false"></dragonfish-editor-lite>
            </form>
        </div>
    </ng-container>
    <ng-template #viewingComment>
        <div class="comment-box border-gray-600 dark:border-white">
            <div class="comment-top border-gray-600 dark:border-white">
                <img class="block border-2 border-gray-600 dark:border-white rounded-md w-10 h-10" [src]="comment.user.profile.avatar" [alt]="'avatar'">
                <div class="mx-1"></div>
                <div class="ml-0.5">
                    <div class="flex items-center relative top-1">
                        <dragonfish-role-badge [roles]="comment.user.roles" [size]="'small'"></dragonfish-role-badge>
                        <h5 class="font-medium ml-0.5 relative top-0.5">
                            <a [routerLink]="['/profile', comment.user._id, comment.user.userTag]">
                                {{ comment.user.screenName }}
                            </a>
                        </h5>
                    </div>
                    <div class="flex items-center">
                        <span class="text-xs italic relative top-0.5">{{ comment.user.profile.tagline ? comment.user.profile.tagline : 'Member' }}</span>
                        <span class="mx-1">•</span>
                        <span class="text-xs italic relative top-0.5">{{ comment.createdAt | localedate: 'mediumDate' }}</span>
                    </div>
                </div>
                <div class="flex-1"></div>
                <ng-container *ngIf="auth.checkPseudonym(comment.user._id); else notThisUser">
                    <button>
                        <rmx-icon name="reply-line"></rmx-icon>
                        <span>Reply</span>
                    </button>
                    <button (click)="toggleEditMode()">
                        <rmx-icon name="edit-line"></rmx-icon>
                        <span>Edit</span>
                    </button>
                </ng-container>
                <ng-template #notThisUser>
                    <ng-container *ngIf="session.isLoggedIn">
                        <button>
                            <rmx-icon name="reply-line"></rmx-icon>
                            <span>Reply</span>
                        </button>
                        <div class="mx-0.5"></div>
                        <button>
                            <rmx-icon name="more-2-fill" class="mr-0"></rmx-icon>
                        </button>
                    </ng-container>
                </ng-template>
            </div>
            <div class="comment-body">
                <markdown [data]="comment.body"></markdown>
            </div>
            <div class="comment-reactions">
                <div class="flex-1"></div>
                <a (click)="addReaction()">
                    <rmx-icon name="emotion-happy-line"></rmx-icon>
                    <span>React</span>
                </a>
            </div>
        </div>
    </ng-template>
</ng-template>
